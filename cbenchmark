#!/bin/bash
# cbenchmark - Run all benchmarks in the codebase
# Similar to ctest but for benchmarks
# Usage: ./cbenchmark [--filter PATTERN] [--timeout SECONDS] [--verbose]

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BUILD_DIR="${SCRIPT_DIR}/build"

# Default settings
FILTER=""
TIMEOUT=300
VERBOSE=0
RESULTS_FILE="${BUILD_DIR}/benchmark_results.txt"

# Parse arguments  
while [[ $# -gt 0 ]]; do
    case $1 in
        --filter|-f)
            FILTER="$2"
            shift 2
            ;;
        --timeout|-t)
            TIMEOUT="$2"
            shift 2
            ;;
        --verbose|-v)
            VERBOSE=1
            shift
            ;;
        --help|-h)
            echo "Usage: cbenchmark [OPTIONS]"
            echo "  --filter, -f PATTERN   Run only benchmarks matching pattern"
            echo "  --timeout, -t SECONDS  Timeout per benchmark (default: 300)"
            echo "  --verbose, -v          Show detailed output"
            echo "  --help, -h             Show this help"
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            exit 1
            ;;
    esac
done

echo "╔══════════════════════════════════════════════════════════════════╗"
echo "║          CUDA ZSTD BENCHMARK SUITE (cbenchmark)                  ║"
echo "╚══════════════════════════════════════════════════════════════════╝"
echo ""
echo "Build directory: ${BUILD_DIR}"
echo "Timeout per benchmark: ${TIMEOUT}s"
echo ""

# Find all benchmark executables
BENCHMARKS=$(find "${BUILD_DIR}" -maxdepth 1 -type f -name "benchmark_*" -executable 2>/dev/null | sort)

if [ -z "$BENCHMARKS" ]; then
    echo "ERROR: No benchmarks found in ${BUILD_DIR}"
    echo "Please build the project first with: cmake --build build"
    exit 1
fi

# Filter if requested
if [ -n "$FILTER" ]; then
    BENCHMARKS=$(echo "$BENCHMARKS" | grep "$FILTER")
    echo "Filter: $FILTER"
fi

TOTAL=$(echo "$BENCHMARKS" | wc -l)
PASSED=0
FAILED=0
TIMEOUT_COUNT=0

echo "═══════════════════════════════════════════════════════════════════"
printf "%-40s %-10s %-15s\n" "BENCHMARK" "STATUS" "TIME"
echo "───────────────────────────────────────────────────────────────────"

# Clear results file
echo "Benchmark Results - $(date)" > "$RESULTS_FILE"
echo "═══════════════════════════════════════════════════════════════════" >> "$RESULTS_FILE"

for BENCH in $BENCHMARKS; do
    NAME=$(basename "$BENCH")
    
    # Run benchmark with timeout
    START_TIME=$(date +%s.%N)
    
    if [ $VERBOSE -eq 1 ]; then
        timeout $TIMEOUT "$BENCH" 2>&1 | tee -a "$RESULTS_FILE"
        RESULT=$?
    else
        OUTPUT=$(timeout $TIMEOUT "$BENCH" 2>&1)
        RESULT=$?
        echo "$OUTPUT" >> "$RESULTS_FILE"
    fi
    
    END_TIME=$(date +%s.%N)
    ELAPSED=$(echo "$END_TIME - $START_TIME" | bc 2>/dev/null || echo "N/A")
    
    if [ $RESULT -eq 0 ]; then
        STATUS="✅ PASS"
        ((PASSED++))
    elif [ $RESULT -eq 124 ]; then
        STATUS="⏱️ TIMEOUT"
        ((TIMEOUT_COUNT++))
        ((FAILED++))
    else
        STATUS="❌ FAIL"
        ((FAILED++))
    fi
    
    printf "%-40s %-10s %-15s\n" "$NAME" "$STATUS" "${ELAPSED}s"
    echo "---" >> "$RESULTS_FILE"
done

echo "═══════════════════════════════════════════════════════════════════"
echo ""
echo "SUMMARY"
echo "───────────────────────────────────────────────────────────────────"
echo "Total:    $TOTAL"
echo "Passed:   $PASSED"
echo "Failed:   $FAILED"
echo "Timeouts: $TIMEOUT_COUNT"
echo ""
echo "Results saved to: $RESULTS_FILE"

if [ $FAILED -eq 0 ]; then
    echo ""
    echo "🎉 ALL BENCHMARKS PASSED!"
    exit 0
else
    echo ""
    echo "⚠️  Some benchmarks failed or timed out"
    exit 1
fi
